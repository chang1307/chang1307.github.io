<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>慢性處方箋領藥時間計算器 | Chronic Prescription Refill Calculator | Máy Tính Thời Gian Lĩnh Thuốc</title>
  
  <!-- 多語言SEO優化 -->
  <link rel="alternate" hreflang="zh-TW" href="https://example.com/index.html">
  <link rel="alternate" hreflang="en-US" href="https://example.com/en.html">
  <link rel="alternate" hreflang="vi-VN" href="https://example.com/vi.html">
  
  <!-- React和相關依賴 -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from { 
        opacity: 0;
        transform: translateY(-10px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .flag-button {
      background: transparent;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    
    .flag-button.active {
      border: 2px solid #4299e1;
      opacity: 1;
    }
    
    .flag-button:not(.active) {
      opacity: 0.7;
    }
    
    .flag-button:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // 語言數據
    const translations = {
      'zh-TW': {
        title: '慢性處方箋領藥時間計算器',
        firstVisitDate: '看診日期 (第一次領藥日期)',
        prescriptionDays: '慢性處方箋天數',
        refillTimes: '本慢箋可領藥次數',
        actualSecondRefillDate: '實際第二次領藥日期 (選填，若已過第二次領藥)',
        calculateButton: '計算領藥與回診時間',
        calculating: '計算中...',
        results: '計算結果',
        prescriptionInfo: '處方資訊',
        firstRefillDate: '首次領藥日期',
        validityEndDate: '處方有效期限',
        validityEndDateSuffix: '(首次領藥後90天)',
        secondRefill: '第二次領藥',
        earliestRefillDate: '最早可領藥日期',
        remainingLessThan10Days: '(藥品剩餘<10天時)',
        standardRefillDate: '標準領藥日期',
        medicationEmptyDate: '(藥品用完時)',
        actualRefillDate: '實際領藥日期',
        thirdRefill: '第三次領藥',
        fourthRefill: '第四次領藥',
        refillDateInvalid: '此次領藥時間已超過處方箋有效期限，無法領藥。請重新回診開立處方。',
        nextVisit: '下次回診時間',
        earliestNextVisitDate: '最早可回診日期',
        standardNextVisitDate: '標準回診日期',
        days: '天',
        times: '次',
        yearSelector: '選擇年份',
        monthSelector: '選擇月份',
        daySelector: '選擇日期',
        year: '年',
        month: '月',
        day: '日',
        selectYear: '請選擇年份',
        selectMonth: '請選擇月份',
        selectDay: '請選擇日期',
        pleaseSelectVisitDate: '請填寫看診日期',
        instruction: '說明',
        instruction1: '根據台灣健保制度，慢性病連續處方箋規定：',
        instruction2: '慢性處方箋有效期限為首次領藥日起90天內',
        instruction3: '一般處方天數為21天至30天',
        instruction4: '可領藥次數通常為2至4次（僅21-22天處方可領4次）',
        instruction5: '最早可於藥品剩餘<10天時提前領藥',
        instruction6: '如果延遲領藥，後續領藥時間會順延，但必須在90天有效期內完成所有領藥',
        usage: '使用方法',
        usage1: '輸入首次看診/領藥日期',
        usage2: '選擇慢性處方箋天數',
        usage3: '選擇可領藥次數',
        usage4: '若已過第二次領藥，可選填實際第二次領藥日期，系統會據此調整後續日期',
        usage5: '點擊計算按鈕即可獲得領藥和回診時間',
        caution: '注意',
        cautionText: '此計算器僅供參考，實際領藥時間可能受醫院或藥局營業時間、假日等因素影響。請依照醫囑按時服藥並適時回診。'
      },
      'en-US': {
        title: 'Chronic Prescription Refill Calculator',
        firstVisitDate: 'First Visit Date (First Refill Date)',
        prescriptionDays: 'Prescription Days',
        refillTimes: 'Number of Refills Allowed',
        actualSecondRefillDate: 'Actual Second Refill Date (Optional)',
        calculateButton: 'Calculate Refill & Visit Dates',
        calculating: 'Calculating...',
        results: 'Results',
        prescriptionInfo: 'Prescription Information',
        firstRefillDate: 'First Refill Date',
        validityEndDate: 'Prescription Validity End Date',
        validityEndDateSuffix: '(90 days after first refill)',
        secondRefill: 'Second Refill',
        earliestRefillDate: 'Earliest Refill Date',
        remainingLessThan10Days: '(when medication remaining < 10 days)',
        standardRefillDate: 'Standard Refill Date',
        medicationEmptyDate: '(when medication is empty)',
        actualRefillDate: 'Actual Refill Date',
        thirdRefill: 'Third Refill',
        fourthRefill: 'Fourth Refill',
        refillDateInvalid: 'This refill date exceeds the prescription validity period. Please visit your doctor for a new prescription.',
        nextVisit: 'Next Doctor Visit',
        earliestNextVisitDate: 'Earliest Visit Date',
        standardNextVisitDate: 'Standard Visit Date',
        days: 'days',
        times: 'times',
        yearSelector: 'Select Year',
        monthSelector: 'Select Month',
        daySelector: 'Select Day',
        year: 'Year',
        month: 'Month',
        day: 'Day',
        selectYear: 'Select Year',
        selectMonth: 'Select Month',
        selectDay: 'Select Day',
        pleaseSelectVisitDate: 'Please enter the first visit date',
        instruction: 'Instructions',
        instruction1: 'According to Taiwan\'s National Health Insurance regulations for chronic prescriptions:',
        instruction2: 'The prescription is valid for 90 days from the first refill date',
        instruction3: 'Standard prescription period is 21 to 30 days',
        instruction4: 'Number of refills allowed is typically 2 to 4 (only 21-22 day prescriptions can have 4 refills)',
        instruction5: 'Earliest refill is allowed when medication remaining is less than 10 days',
        instruction6: 'If refill is delayed, subsequent refill dates will be adjusted, but all refills must be completed within the 90-day validity period',
        usage: 'How to Use',
        usage1: 'Enter your first visit/refill date',
        usage2: 'Select the prescription days',
        usage3: 'Select the number of refills allowed',
        usage4: 'If you\'ve already had your second refill, you can enter the actual date to adjust subsequent dates',
        usage5: 'Click the calculate button to get refill and visit dates',
        caution: 'Caution',
        cautionText: 'This calculator is for reference only. Actual refill dates may be affected by hospital or pharmacy hours, holidays, etc. Please follow your doctor\'s instructions for medication and visits.'
      },
      'vi-VN': {
        title: 'Máy Tính Thời Gian Lĩnh Thuốc Theo Đơn Dài Hạn',
        firstVisitDate: 'Ngày Khám (Ngày Lĩnh Thuốc Đầu Tiên)',
        prescriptionDays: 'Số Ngày Thuốc',
        refillTimes: 'Số Lần Lĩnh Thuốc Được Phép',
        actualSecondRefillDate: 'Ngày Lĩnh Thuốc Thứ Hai Thực Tế (Tùy Chọn)',
        calculateButton: 'Tính Toán Ngày Lĩnh Thuốc & Tái Khám',
        calculating: 'Đang tính toán...',
        results: 'Kết Quả',
        prescriptionInfo: 'Thông Tin Đơn Thuốc',
        firstRefillDate: 'Ngày Lĩnh Thuốc Đầu Tiên',
        validityEndDate: 'Ngày Hết Hạn Đơn Thuốc',
        validityEndDateSuffix: '(90 ngày sau lần lĩnh thuốc đầu tiên)',
        secondRefill: 'Lĩnh Thuốc Lần Thứ Hai',
        earliestRefillDate: 'Ngày Lĩnh Thuốc Sớm Nhất',
        remainingLessThan10Days: '(khi thuốc còn lại < 10 ngày)',
        standardRefillDate: 'Ngày Lĩnh Thuốc Tiêu Chuẩn',
        medicationEmptyDate: '(khi hết thuốc)',
        actualRefillDate: 'Ngày Lĩnh Thuốc Thực Tế',
        thirdRefill: 'Lĩnh Thuốc Lần Thứ Ba',
        fourthRefill: 'Lĩnh Thuốc Lần Thứ Tư',
        refillDateInvalid: 'Ngày lĩnh thuốc này vượt quá thời hạn hiệu lực của đơn thuốc. Vui lòng đến gặp bác sĩ để được cấp đơn thuốc mới.',
        nextVisit: 'Lần Tái Khám Tiếp Theo',
        earliestNextVisitDate: 'Ngày Tái Khám Sớm Nhất',
        standardNextVisitDate: 'Ngày Tái Khám Tiêu Chuẩn',
        days: 'ngày',
        times: 'lần',
        yearSelector: 'Chọn Năm',
        monthSelector: 'Chọn Tháng',
        daySelector: 'Chọn Ngày',
        year: 'Năm',
        month: 'Tháng',
        day: 'Ngày',
        selectYear: 'Chọn Năm',
        selectMonth: 'Chọn Tháng',
        selectDay: 'Chọn Ngày',
        pleaseSelectVisitDate: 'Vui lòng nhập ngày khám đầu tiên',
        instruction: 'Hướng Dẫn',
        instruction1: 'Theo quy định của Bảo hiểm Y tế Quốc gia Đài Loan đối với đơn thuốc dài hạn:',
        instruction2: 'Đơn thuốc có hiệu lực trong 90 ngày kể từ ngày lĩnh thuốc đầu tiên',
        instruction3: 'Thời gian đơn thuốc tiêu chuẩn là 21 đến 30 ngày',
        instruction4: 'Số lần lĩnh thuốc được phép thường là 2 đến 4 (chỉ đơn thuốc 21-22 ngày có thể có 4 lần lĩnh thuốc)',
        instruction5: 'Được phép lĩnh thuốc sớm nhất khi lượng thuốc còn lại dưới 10 ngày',
        instruction6: 'Nếu việc lĩnh thuốc bị trì hoãn, ngày lĩnh thuốc tiếp theo sẽ được điều chỉnh, nhưng tất cả các lần lĩnh thuốc phải được hoàn thành trong thời hạn hiệu lực 90 ngày',
        usage: 'Cách Sử Dụng',
        usage1: 'Nhập ngày khám/lĩnh thuốc đầu tiên của bạn',
        usage2: 'Chọn số ngày thuốc',
        usage3: 'Chọn số lần lĩnh thuốc được phép',
        usage4: 'Nếu bạn đã lĩnh thuốc lần thứ hai, bạn có thể nhập ngày thực tế để điều chỉnh các ngày tiếp theo',
        usage5: 'Nhấp vào nút tính toán để nhận ngày lĩnh thuốc và ngày tái khám',
        caution: 'Lưu Ý',
        cautionText: 'Máy tính này chỉ mang tính tham khảo. Ngày lĩnh thuốc thực tế có thể bị ảnh hưởng bởi giờ làm việc của bệnh viện hoặc hiệu thuốc, ngày lễ, v.v. Vui lòng làm theo hướng dẫn của bác sĩ để uống thuốc và tái khám.'
      }
    };

    // 國旗圖標（使用國家代碼表示）
    const flags = {
      'zh-TW': '🇹🇼',
      'en-US': '🇺🇸',
      'vi-VN': '🇻🇳'
    };

    function LanguageSwitcher({ currentLang, onLanguageChange }) {
      return (
        <div style={{
          position: 'absolute',
          top: '20px',
          right: '20px',
          display: 'flex',
          gap: '10px',
        }}>
          {Object.keys(flags).map(lang => (
            <button
              key={lang}
              onClick={() => onLanguageChange(lang)}
              className={`flag-button ${lang === currentLang ? 'active' : ''}`}
              title={lang}
            >
              {flags[lang]}
            </button>
          ))}
        </div>
      );
    }

    function App() {
      // 狀態變數
      const [language, setLanguage] = React.useState('zh-TW');
      const [firstVisitDate, setFirstVisitDate] = React.useState('');
      const [firstVisitYear, setFirstVisitYear] = React.useState('');
      const [firstVisitMonth, setFirstVisitMonth] = React.useState('');
      const [firstVisitDay, setFirstVisitDay] = React.useState('');
      const [actualSecondRefillDate, setActualSecondRefillDate] = React.useState('');
      const [actualSecondYear, setActualSecondYear] = React.useState('');
      const [actualSecondMonth, setActualSecondMonth] = React.useState('');
      const [actualSecondDay, setActualSecondDay] = React.useState('');
      const [prescriptionDays, setPrescriptionDays] = React.useState('28');
      const [refillTimes, setRefillTimes] = React.useState('3');
      const [results, setResults] = React.useState(null);
      const [today, setToday] = React.useState('');
      const [isCalculating, setIsCalculating] = React.useState(false);

      // 當前語言的翻譯
      const t = translations[language];

      // 建立年份選項
      const currentYear = new Date().getFullYear();
      const years = Array.from({ length: 10 }, (_, i) => currentYear - 5 + i);
      
      // 建立月份選項
      const months = Array.from({ length: 12 }, (_, i) => i + 1);
      
      // 建立日期選項
      const getDaysInMonth = (year, month) => {
        return new Date(year, month, 0).getDate();
      };

      // 根據選擇的年月計算可用的日期
      const getAvailableDays = (year, month) => {
        if (!year || !month) return Array.from({ length: 31 }, (_, i) => i + 1);
        const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
        return Array.from({ length: daysInMonth }, (_, i) => i + 1);
      };
      
      const firstVisitDays = getAvailableDays(firstVisitYear, firstVisitMonth);
      const actualSecondDays = getAvailableDays(actualSecondYear, actualSecondMonth);

      // 設置今天的日期
      React.useEffect(() => {
        const date = new Date();
        const formattedDate = date.toISOString().split('T')[0];
        setToday(formattedDate);
        
        // 設置初始日期為今天
        const currentYear = date.getFullYear().toString();
        const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0');
        const currentDay = date.getDate().toString().padStart(2, '0');
        
        setFirstVisitYear(currentYear);
        setFirstVisitMonth(currentMonth);
        setFirstVisitDay(currentDay);
        updateFirstVisitDate(currentYear, currentMonth, currentDay);
        
        // 檢查瀏覽器語言設置，設置初始語言
        const browserLang = navigator.language || navigator.userLanguage;
        if (browserLang.startsWith('zh')) {
          setLanguage('zh-TW');
        } else if (browserLang.startsWith('vi')) {
          setLanguage('vi-VN');
        } else {
          setLanguage('en-US'); // 默認英語
        }
      }, []);
      
      // 處理處方天數變更，確保有效的領藥次數
      React.useEffect(() => {
        // 如果天數大於22天，且選擇了4次，則重置為3次
        if (parseInt(prescriptionDays) > 22 && refillTimes === '4') {
          setRefillTimes('3');
        }
      }, [prescriptionDays, refillTimes]);
      
      // 當年月日選擇變化時更新日期字串
      const updateFirstVisitDate = (year, month, day) => {
        if (year && month && day) {
          const formattedMonth = month.padStart(2, '0');
          const formattedDay = day.padStart(2, '0');
          setFirstVisitDate(`${year}-${formattedMonth}-${formattedDay}`);
        }
      };
      
      const updateActualSecondDate = (year, month, day) => {
        if (year && month && day) {
          const formattedMonth = month.padStart(2, '0');
          const formattedDay = day.padStart(2, '0');
          setActualSecondRefillDate(`${year}-${formattedMonth}-${formattedDay}`);
        } else {
          setActualSecondRefillDate('');
        }
      };
      
      // 當年月日選擇變化時更新日期
      React.useEffect(() => {
        updateFirstVisitDate(firstVisitYear, firstVisitMonth, firstVisitDay);
      }, [firstVisitYear, firstVisitMonth, firstVisitDay]);
      
      React.useEffect(() => {
        updateActualSecondDate(actualSecondYear, actualSecondMonth, actualSecondDay);
      }, [actualSecondYear, actualSecondMonth, actualSecondDay]);

      // 格式化日期顯示
      const formatDateForDisplay = (date) => {
        const d = new Date(date);
        
        // 根據當前語言格式化日期
        if (language === 'zh-TW') {
          return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
        } else if (language === 'vi-VN') {
          return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
        } else {
          // 英文格式
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
        }
      };

      // 計算領藥日期和回診日期
      const calculateDates = () => {
        if (!firstVisitDate) {
          alert(t.pleaseSelectVisitDate);
          return;
        }

        // 顯示計算動畫
        setIsCalculating(true);
        
        // 先清空結果，讓用戶知道正在重新計算
        setResults(null);
        
        // 使用requestAnimationFrame來確保UI更新後再進行計算
        requestAnimationFrame(() => {
          const days = parseInt(prescriptionDays);
          const times = parseInt(refillTimes);
          
          // 計算標準領藥日期
          const firstDate = new Date(firstVisitDate);
          
          // 第一次領藥是在就診當天
          const firstRefillDate = new Date(firstDate);
          
          // 計算最早第二次領藥日期（剩餘藥品不足10天時）
          const earliestSecondRefill = new Date(firstDate);
          earliestSecondRefill.setDate(firstDate.getDate() + days - 10);
          
          // 計算標準第二次領藥日期
          const standardSecondRefill = new Date(firstDate);
          standardSecondRefill.setDate(firstDate.getDate() + days);
          
          // 計算90天處方有效期結束日期
          const validityEndDate = new Date(firstDate);
          validityEndDate.setDate(firstDate.getDate() + 90);
          
          // 處理實際第二次領藥日期（如有）
          let thirdRefillDate, earliestThirdRefill, isThirdRefillValid = true;
          if (actualSecondRefillDate) {
            // 如果用戶指定了實際第二次領藥日期
            const actualDate = new Date(actualSecondRefillDate);
            
            // 根據實際第二次領藥計算最早第三次領藥
            earliestThirdRefill = new Date(actualDate);
            earliestThirdRefill.setDate(actualDate.getDate() + days - 10);
            
            // 計算標準第三次領藥日期
            thirdRefillDate = new Date(actualDate);
            thirdRefillDate.setDate(actualDate.getDate() + days);
            
            // 檢查第三次領藥是否超過處方有效期
            if (thirdRefillDate > validityEndDate) {
              isThirdRefillValid = false;
            }
          } else {
            // 根據標準第二次領藥日期計算
            earliestThirdRefill = new Date(standardSecondRefill);
            earliestThirdRefill.setDate(standardSecondRefill.getDate() + days - 10);
            
            thirdRefillDate = new Date(standardSecondRefill);
            thirdRefillDate.setDate(standardSecondRefill.getDate() + days);
            
            // 檢查第三次領藥是否超過處方有效期
            if (thirdRefillDate > validityEndDate) {
              isThirdRefillValid = false;
            }
          }
          
          // 如適用，計算第四次領藥日期
          let fourthRefillDate, earliestFourthRefill, isFourthRefillValid = true;
          if (times > 3) {
            earliestFourthRefill = new Date(thirdRefillDate);
            earliestFourthRefill.setDate(thirdRefillDate.getDate() + days - 10);
            
            fourthRefillDate = new Date(thirdRefillDate);
            fourthRefillDate.setDate(thirdRefillDate.getDate() + days);
            
            // 檢查第四次領藥是否超過處方有效期
            if (fourthRefillDate > validityEndDate || !isThirdRefillValid) {
              isFourthRefillValid = false;
            }
          }
          
          // 根據最後一次有效領藥計算下次回診日期
          let nextVisitDate, earliestNextVisit;
          
          // 計算最後一次處方用完的日期
          const lastPrescriptionDate = times === 2 ? standardSecondRefill : 
                                    times === 3 ? (isThirdRefillValid ? thirdRefillDate : (actualSecondRefillDate ? new Date(actualSecondRefillDate) : standardSecondRefill)) : 
                                    (isFourthRefillValid ? fourthRefillDate : (isThirdRefillValid ? thirdRefillDate : (actualSecondRefillDate ? new Date(actualSecondRefillDate) : standardSecondRefill)));
          
          // 最早回診日期（藥品剩餘不足10天）
          earliestNextVisit = new Date(lastPrescriptionDate);
          earliestNextVisit.setDate(lastPrescriptionDate.getDate() + days - 10);
          
          // 標準回診日期（藥品用完時）
          nextVisitDate = new Date(lastPrescriptionDate);
          nextVisitDate.setDate(lastPrescriptionDate.getDate() + days);
          
          // 儲存結果
          setResults({
            firstVisitDate: firstDate,
            earliestSecondRefill: earliestSecondRefill,
            standardSecondRefill: standardSecondRefill,
            actualSecondRefill: actualSecondRefillDate ? new Date(actualSecondRefillDate) : null,
            earliestThirdRefill: earliestThirdRefill,
            thirdRefillDate: thirdRefillDate,
            isThirdRefillValid: isThirdRefillValid,
            earliestFourthRefill: times > 3 ? earliestFourthRefill : null,
            fourthRefillDate: times > 3 ? fourthRefillDate : null,
            isFourthRefillValid: times > 3 ? isFourthRefillValid : false,
            earliestNextVisit: earliestNextVisit,
            nextVisitDate: nextVisitDate,
            validityEndDate: validityEndDate,
            calculatedAt: new Date().getTime() // 添加計算時間戳記，確保每次計算都有不同的結果對象
          });
          
          // 隱藏計算動畫
          setIsCalculating(false);
          
          // 計算完成後滾動到結果區域
          const resultsElement = document.getElementById('results-section');
          if (resultsElement) {
            resultsElement.scrollIntoView({ behavior: 'smooth' });
          }
        });
      };

      // 頁面樣式
      const styles = {
        app: {
          minHeight: '100vh',
          padding: '20px',
          position: 'relative',
        },
        container: {
          maxWidth: '800px',
          margin: '0 auto',
        },
        title: {
          fontSize: '24px',
          textAlign: 'center',
          marginBottom: '20px',
          color: '#333',
          fontWeight: 'bold',
          paddingTop: '40px', // 為語言切換器留出空間
        },
        card: {
          background: 'white',
          borderRadius: '8px',
          boxShadow: '0 2px 10px rgba(0, 0, 0, 0.1)',
          padding: '20px',
          marginBottom: '20px',
        },
        formGroup: {
          marginBottom: '20px',
        },
        label: {
          display: 'block',
          marginBottom: '5px',
          fontWeight: '500',
        },
        required: {
          color: '#e53e3e',
        },
        formControl: {
          width: '100%',
          padding: '10px',
          border: '1px solid #ddd',
          borderRadius: '4px',
          fontSize: '16px',
        },
        buttonContainer: {
          marginTop: '20px',
          textAlign: 'center',
        },
        calculateButton: {
          backgroundColor: '#4299e1',
          color: 'white',
          border: 'none',
          borderRadius: '4px',
          padding: '10px 20px',
          fontSize: '16px',
          cursor: 'pointer',
          fontWeight: '500',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          margin: '0 auto',
          minWidth: '180px',
        },
      };

      // 更新網頁標題和語言
      React.useEffect(() => {
        // 更新HTML標籤的lang屬性
        document.documentElement.setAttribute('lang', language);
        
        // 更新頁面標題
        document.title = `${t.title}`;
      }, [language, t.title]);

      return (
        <div style={styles.app}>
          <div style={styles.container}>
            <LanguageSwitcher 
              currentLang={language} 
              onLanguageChange={setLanguage}
            />
            
            <h1 style={styles.title}>{t.title}</h1>
            
            <div style={styles.card}>
              <div style={{
                display: 'grid',
                gridTemplateColumns: window.innerWidth > 768 ? '1fr 1fr' : '1fr',
                gap: '15px'
              }}>
                <div style={styles.formGroup}>
                  <label style={styles.label}>
                    {t.firstVisitDate} <span style={styles.required}>*</span>
                  </label>
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <select 
                      style={{ ...styles.formControl, flex: 1 }}
                      value={firstVisitYear}
                      onChange={(e) => setFirstVisitYear(e.target.value)}
                    >
                      <option value="">{t.selectYear}</option>
                      {years.map(year => (
                        <option key={year} value={year}>{year} {t.year}</option>
                      ))}
                    </select>
                    
                    <select 
                      style={{ ...styles.formControl, flex: 1 }}
                      value={firstVisitMonth}
                      onChange={(e) => {
                        const newMonth = e.target.value;
                        setFirstVisitMonth(newMonth);
                        
                        // 當選擇的月份變化時，檢查日期是否有效
                        if (firstVisitDay) {
                          const daysInNewMonth = getDaysInMonth(parseInt(firstVisitYear), parseInt(newMonth));
                          if (parseInt(firstVisitDay) > daysInNewMonth) {
                            setFirstVisitDay(daysInNewMonth.toString());
                          }
                        }
                      }}
                    >
                      <option value="">{t.selectMonth}</option>
                      {months.map(month => (
                        <option key={month} value={month.toString().padStart(2, '0')}>{month} {t.month}</option>
                      ))}
                    </select>
                    
                    <select 
                      style={{ ...styles.formControl, flex: 1 }}
                      value={firstVisitDay}
                      onChange={(e) => setFirstVisitDay(e.target.value)}
                    >
                      <option value="">{t.selectDay}</option>
                      {firstVisitDays.map(day => (
                        <option key={day} value={day.toString().padStart(2, '0')}>{day} {t.day}</option>
                      ))}
                    </select>
                  </div>
                </div>
                
                <div style={styles.formGroup}>
                  <label style={styles.label}>
                    {t.prescriptionDays} <span style={styles.required}>*</span>
                  </label>
                  <select
                    style={styles.formControl}
                    value={prescriptionDays}
                    onChange={(e) => setPrescriptionDays(e.target.value)}
                  >
                    {Array.from({ length: 10 }, (_, i) => i + 21).map(day => (
                      <option key={day} value={day.toString()}>{day} {t.days}</option>
                    ))}
                  </select>
                </div>
                
                <div style={styles.formGroup}>
                  <label style={styles.label}>
                    {t.refillTimes} <span style={styles.required}>*</span>
                  </label>
                  <select
                    style={styles.formControl}
                    value={refillTimes}
                    onChange={(e) => setRefillTimes(e.target.value)}
                  >
                    <option value="2">2 {t.times}</option>
                    <option value="3">3 {t.times}</option>
                    {parseInt(prescriptionDays) <= 22 && <option value="4">4 {t.times}</option>}
                  </select>
                </div>
                
                <div style={styles.formGroup}>
                  <label style={styles.label}>
                    {t.actualSecondRefillDate}
                  </label>
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <select 
                      style={{ ...styles.formControl, flex: 1 }}
                      value={actualSecondYear}
                      onChange={(e) => setActualSecondYear(e.target.value)}
                    >
                      <option value="">{t.selectYear}</option>
                      {years.map(year => (
                        <option key={year} value={year}>{year} {t.year}</option>
                      ))}
                    </select>
                    
                    <select 
                      style={{ ...styles.formControl, flex: 1 }}
                      value={actualSecondMonth}
                      onChange={(e) => {
                        const newMonth = e.target.value;
                        setActualSecondMonth(newMonth);
                        
                        // 當選擇的月份變化時，檢查日期是否有效
                        if (actualSecondDay) {
                          const daysInNewMonth = getDaysInMonth(parseInt(actualSecondYear), parseInt(newMonth));
                          if (parseInt(actualSecondDay) > daysInNewMonth) {
                            setActualSecondDay(daysInNewMonth.toString());
                          }
                        }
                      }}
                      disabled={!actualSecondYear}
                    >
                      <option value="">{t.selectMonth}</option>
                      {months.map(month => (
                        <option key={month} value={month.toString().padStart(2, '0')}>{month} {t.month}</option>
                      ))}
                    </select>
                    
                    <select 
                      style={{ ...styles.formControl, flex: 1 }}
                      value={actualSecondDay}
                      onChange={(e) => setActualSecondDay(e.target.value)}
                      disabled={!actualSecondMonth}
                    >
                      <option value="">{t.selectDay}</option>
                      {actualSecondDays.map(day => (
                        <option key={day} value={day.toString().padStart(2, '0')}>{day} {t.day}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
              
              <div style={styles.buttonContainer}>
                <button
                  style={{
                    ...styles.calculateButton,
                    cursor: isCalculating ? 'wait' : 'pointer',
                    opacity: isCalculating ? 0.8 : 1,
                  }}
                  onClick={calculateDates}
                  disabled={isCalculating}
                >
                  {isCalculating ? (
                    <>
                      <div style={{
                        width: '20px',
                        height: '20px',
                        border: '3px solid rgba(255,255,255,0.3)',
                        borderRadius: '50%',
                        borderTopColor: 'white',
                        animation: 'spin 1s linear infinite',
                        marginRight: '10px',
                      }}></div>
                      {t.calculating}
                    </>
                  ) : (
                    t.calculateButton
                  )}
                </button>
              </div>
            </div>
            
            {results && (
              <div id="results-section" style={{...styles.card, marginTop: '30px', animation: 'fadeIn 0.5s ease-in'}}>
                <h2 style={{
                  fontSize: '20px',
                  marginBottom: '15px',
                  borderBottom: '1px solid #eee',
                  paddingBottom: '10px',
                }}>{t.results}</h2>
                
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '20px',
                }}>
                  <div style={{
                    paddingBottom: '15px',
                    borderBottom: '1px solid #eee',
                    animation: 'slideDown 0.3s ease-out',
                  }}>
                    <h3 style={{
                      fontSize: '18px',
                      marginBottom: '10px',
                      color: '#4a5568',
                    }}>{t.prescriptionInfo}</h3>
                    <p><span style={{fontWeight: '600'}}>{t.firstRefillDate}：</span> {formatDateForDisplay(results.firstVisitDate)}</p>
                    <p><span style={{fontWeight: '600'}}>{t.validityEndDate}：</span> {formatDateForDisplay(results.validityEndDate)} {t.validityEndDateSuffix}</p>
                  </div>
                  
                  <div style={{
                    paddingBottom: '15px',
                    borderBottom: '1px solid #eee',
                    animation: 'slideDown 0.3s ease-out 0.1s',
                    animationFillMode: 'both',
                  }}>
                    <h3 style={{
                      fontSize: '18px',
                      marginBottom: '10px',
                      color: '#4a5568',
                    }}>{t.secondRefill}</h3>
                    <p>
                      <span style={{fontWeight: '600'}}>{t.earliestRefillDate}：</span> 
                      <span style={{color: '#3182ce', fontWeight: '600'}}>{formatDateForDisplay(results.earliestSecondRefill)}</span> 
                      {t.remainingLessThan10Days}
                    </p>
                    <p>
                      <span style={{fontWeight: '600'}}>{t.standardRefillDate}：</span> 
                      {formatDateForDisplay(results.standardSecondRefill)} 
                      {t.medicationEmptyDate}
                    </p>
                    {results.actualSecondRefill && (
                      <p>
                        <span style={{fontWeight: '600'}}>{t.actualRefillDate}：</span> 
                        {formatDateForDisplay(results.actualSecondRefill)}
                      </p>
                    )}
                  </div>
                  
                  {parseInt(refillTimes) >= 3 && (
                    <div style={{
                      paddingBottom: '15px',
                      borderBottom: '1px solid #eee',
                      animation: 'slideDown 0.3s ease-out 0.2s',
                      animationFillMode: 'both',
                    }}>
                      <h3 style={{
                        fontSize: '18px',
                        marginBottom: '10px',
                        color: '#4a5568',
                      }}>{t.thirdRefill}</h3>
                      {results.isThirdRefillValid ? (
                        <>
                          <p>
                            <span style={{fontWeight: '600'}}>{t.earliestRefillDate}：</span> 
                            <span style={{color: '#3182ce', fontWeight: '600'}}>{formatDateForDisplay(results.earliestThirdRefill)}</span> 
                            {t.remainingLessThan10Days}
                          </p>
                          <p>
                            <span style={{fontWeight: '600'}}>{t.standardRefillDate}：</span> 
                            {formatDateForDisplay(results.thirdRefillDate)} 
                            {t.medicationEmptyDate}
                          </p>
                        </>
                      ) : (
                        <p style={{color: '#e53e3e', fontWeight: '500'}}>
                          {t.refillDateInvalid} ({formatDateForDisplay(results.validityEndDate)})
                        </p>
                      )}
                    </div>
                  )}
                  
                  {parseInt(refillTimes) >= 4 && results.earliestFourthRefill && (
                    <div style={{
                      paddingBottom: '15px',
                      borderBottom: '1px solid #eee',
                      animation: 'slideDown 0.3s ease-out 0.3s',
                      animationFillMode: 'both',
                    }}>
                      <h3 style={{
                        fontSize: '18px',
                        marginBottom: '10px',
                        color: '#4a5568',
                      }}>{t.fourthRefill}</h3>
                      {results.isFourthRefillValid ? (
                        <>
                          <p>
                            <span style={{fontWeight: '600'}}>{t.earliestRefillDate}：</span> 
                            <span style={{color: '#3182ce', fontWeight: '600'}}>{formatDateForDisplay(results.earliestFourthRefill)}</span> 
                            {t.remainingLessThan10Days}
                          </p>
                          <p>
                            <span style={{fontWeight: '600'}}>{t.standardRefillDate}：</span> 
                            {formatDateForDisplay(results.fourthRefillDate)} 
                            {t.medicationEmptyDate}
                          </p>
                        </>
                      ) : (
                        <p style={{color: '#e53e3e', fontWeight: '500'}}>
                          {t.refillDateInvalid} ({formatDateForDisplay(results.validityEndDate)})
                        </p>
                      )}
                    </div>
                  )}
                  
                  <div style={{
                    paddingBottom: '15px',
                    animation: 'slideDown 0.3s ease-out 0.4s',
                    animationFillMode: 'both',
                  }}>
                    <h3 style={{
                      fontSize: '18px',
                      marginBottom: '10px',
                      color: '#4a5568',
                    }}>{t.nextVisit}</h3>
                    <p>
                      <span style={{fontWeight: '600'}}>{t.earliestNextVisitDate}：</span> 
                      <span style={{color: '#38a169',<!DOCTYPE html>
<html lang="zh-TW">
